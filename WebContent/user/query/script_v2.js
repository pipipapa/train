function Base64(){_keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";this.encode=function(input){var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;input=_utf8_encode(input);while(i<input.length){chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=((chr1&3)<<4)|(chr2>>4);enc3=((chr2&15)<<2)|(chr3>>6);enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64;}else if(isNaN(chr3)){enc4=64;}
output=output+
_keyStr.charAt(enc1)+_keyStr.charAt(enc2)+
_keyStr.charAt(enc3)+_keyStr.charAt(enc4);}
return output;}
this.decode=function(input){var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(i<input.length){enc1=_keyStr.indexOf(input.charAt(i++));enc2=_keyStr.indexOf(input.charAt(i++));enc3=_keyStr.indexOf(input.charAt(i++));enc4=_keyStr.indexOf(input.charAt(i++));chr1=(enc1<<2)|(enc2>>4);chr2=((enc2&15)<<4)|(enc3>>2);chr3=((enc3&3)<<6)|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2);}
if(enc4!=64){output=output+String.fromCharCode(chr3);}}
output=_utf8_decode(output);return output;}
_utf8_encode=function(string){string=string.replace(/\r\n/g,"\n");var utftext="";for(var n=0;n<string.length;n++){var c=string.charCodeAt(n);if(c<128){utftext+=String.fromCharCode(c);}else if((c>127)&&(c<2048)){utftext+=String.fromCharCode((c>>6)|192);utftext+=String.fromCharCode((c&63)|128);}else{utftext+=String.fromCharCode((c>>12)|224);utftext+=String.fromCharCode(((c>>6)&63)|128);utftext+=String.fromCharCode((c&63)|128);}}
return utftext;}
_utf8_decode=function(utftext){var string="";var i=0;var c=c1=c2=0;while(i<utftext.length){c=utftext.charCodeAt(i);if(c<128){string+=String.fromCharCode(c);i++;}else if((c>191)&&(c<224)){c2=utftext.charCodeAt(i+1);string+=String.fromCharCode(((c&31)<<6)|(c2&63));i+=2;}else{c2=utftext.charCodeAt(i+1);c3=utftext.charCodeAt(i+2);string+=String.fromCharCode(((c&15)<<12)|((c2&63)<<6)|(c3&63));i+=3;}}
return string;}}
;//     Underscore.js 1.6.0
//     http://underscorejs.org
//     (c) 2009-2014 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
//     Underscore may be freely distributed under the MIT license.
(function(){var n=this,t=n._,r={},e=Array.prototype,u=Object.prototype,i=Function.prototype,a=e.push,o=e.slice,c=e.concat,l=u.toString,f=u.hasOwnProperty,s=e.forEach,p=e.map,h=e.reduce,v=e.reduceRight,g=e.filter,d=e.every,m=e.some,y=e.indexOf,b=e.lastIndexOf,x=Array.isArray,w=Object.keys,_=i.bind,j=function(n){return n instanceof j?n:this instanceof j?void(this._wrapped=n):new j(n)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=j),exports._=j):n._=j,j.VERSION="1.6.0";var A=j.each=j.forEach=function(n,t,e){if(null==n)return n;if(s&&n.forEach===s)n.forEach(t,e);else if(n.length===+n.length){for(var u=0,i=n.length;i>u;u++)if(t.call(e,n[u],u,n)===r)return}else for(var a=j.keys(n),u=0,i=a.length;i>u;u++)if(t.call(e,n[a[u]],a[u],n)===r)return;return n};j.map=j.collect=function(n,t,r){var e=[];return null==n?e:p&&n.map===p?n.map(t,r):(A(n,function(n,u,i){e.push(t.call(r,n,u,i))}),e)};var O="Reduce of empty array with no initial value";j.reduce=j.foldl=j.inject=function(n,t,r,e){var u=arguments.length>2;if(null==n&&(n=[]),h&&n.reduce===h)return e&&(t=j.bind(t,e)),u?n.reduce(t,r):n.reduce(t);if(A(n,function(n,i,a){u?r=t.call(e,r,n,i,a):(r=n,u=!0)}),!u)throw new TypeError(O);return r},j.reduceRight=j.foldr=function(n,t,r,e){var u=arguments.length>2;if(null==n&&(n=[]),v&&n.reduceRight===v)return e&&(t=j.bind(t,e)),u?n.reduceRight(t,r):n.reduceRight(t);var i=n.length;if(i!==+i){var a=j.keys(n);i=a.length}if(A(n,function(o,c,l){c=a?a[--i]:--i,u?r=t.call(e,r,n[c],c,l):(r=n[c],u=!0)}),!u)throw new TypeError(O);return r},j.find=j.detect=function(n,t,r){var e;return k(n,function(n,u,i){return t.call(r,n,u,i)?(e=n,!0):void 0}),e},j.filter=j.select=function(n,t,r){var e=[];return null==n?e:g&&n.filter===g?n.filter(t,r):(A(n,function(n,u,i){t.call(r,n,u,i)&&e.push(n)}),e)},j.reject=function(n,t,r){return j.filter(n,function(n,e,u){return!t.call(r,n,e,u)},r)},j.every=j.all=function(n,t,e){t||(t=j.identity);var u=!0;return null==n?u:d&&n.every===d?n.every(t,e):(A(n,function(n,i,a){return(u=u&&t.call(e,n,i,a))?void 0:r}),!!u)};var k=j.some=j.any=function(n,t,e){t||(t=j.identity);var u=!1;return null==n?u:m&&n.some===m?n.some(t,e):(A(n,function(n,i,a){return u||(u=t.call(e,n,i,a))?r:void 0}),!!u)};j.contains=j.include=function(n,t){return null==n?!1:y&&n.indexOf===y?n.indexOf(t)!=-1:k(n,function(n){return n===t})},j.invoke=function(n,t){var r=o.call(arguments,2),e=j.isFunction(t);return j.map(n,function(n){return(e?t:n[t]).apply(n,r)})},j.pluck=function(n,t){return j.map(n,j.property(t))},j.where=function(n,t){return j.filter(n,j.matches(t))},j.findWhere=function(n,t){return j.find(n,j.matches(t))},j.max=function(n,t,r){if(!t&&j.isArray(n)&&n[0]===+n[0]&&n.length<65535)return Math.max.apply(Math,n);var e=-1/0,u=-1/0;return A(n,function(n,i,a){var o=t?t.call(r,n,i,a):n;o>u&&(e=n,u=o)}),e},j.min=function(n,t,r){if(!t&&j.isArray(n)&&n[0]===+n[0]&&n.length<65535)return Math.min.apply(Math,n);var e=1/0,u=1/0;return A(n,function(n,i,a){var o=t?t.call(r,n,i,a):n;u>o&&(e=n,u=o)}),e},j.shuffle=function(n){var t,r=0,e=[];return A(n,function(n){t=j.random(r++),e[r-1]=e[t],e[t]=n}),e},j.sample=function(n,t,r){return null==t||r?(n.length!==+n.length&&(n=j.values(n)),n[j.random(n.length-1)]):j.shuffle(n).slice(0,Math.max(0,t))};var E=function(n){return null==n?j.identity:j.isFunction(n)?n:j.property(n)};j.sortBy=function(n,t,r){return t=E(t),j.pluck(j.map(n,function(n,e,u){return{value:n,index:e,criteria:t.call(r,n,e,u)}}).sort(function(n,t){var r=n.criteria,e=t.criteria;if(r!==e){if(r>e||r===void 0)return 1;if(e>r||e===void 0)return-1}return n.index-t.index}),"value")};var F=function(n){return function(t,r,e){var u={};return r=E(r),A(t,function(i,a){var o=r.call(e,i,a,t);n(u,o,i)}),u}};j.groupBy=F(function(n,t,r){j.has(n,t)?n[t].push(r):n[t]=[r]}),j.indexBy=F(function(n,t,r){n[t]=r}),j.countBy=F(function(n,t){j.has(n,t)?n[t]++:n[t]=1}),j.sortedIndex=function(n,t,r,e){r=E(r);for(var u=r.call(e,t),i=0,a=n.length;a>i;){var o=i+a>>>1;r.call(e,n[o])<u?i=o+1:a=o}return i},j.toArray=function(n){return n?j.isArray(n)?o.call(n):n.length===+n.length?j.map(n,j.identity):j.values(n):[]},j.size=function(n){return null==n?0:n.length===+n.length?n.length:j.keys(n).length},j.first=j.head=j.take=function(n,t,r){return null==n?void 0:null==t||r?n[0]:0>t?[]:o.call(n,0,t)},j.initial=function(n,t,r){return o.call(n,0,n.length-(null==t||r?1:t))},j.last=function(n,t,r){return null==n?void 0:null==t||r?n[n.length-1]:o.call(n,Math.max(n.length-t,0))},j.rest=j.tail=j.drop=function(n,t,r){return o.call(n,null==t||r?1:t)},j.compact=function(n){return j.filter(n,j.identity)};var M=function(n,t,r){return t&&j.every(n,j.isArray)?c.apply(r,n):(A(n,function(n){j.isArray(n)||j.isArguments(n)?t?a.apply(r,n):M(n,t,r):r.push(n)}),r)};j.flatten=function(n,t){return M(n,t,[])},j.without=function(n){return j.difference(n,o.call(arguments,1))},j.partition=function(n,t){var r=[],e=[];return A(n,function(n){(t(n)?r:e).push(n)}),[r,e]},j.uniq=j.unique=function(n,t,r,e){j.isFunction(t)&&(e=r,r=t,t=!1);var u=r?j.map(n,r,e):n,i=[],a=[];return A(u,function(r,e){(t?e&&a[a.length-1]===r:j.contains(a,r))||(a.push(r),i.push(n[e]))}),i},j.union=function(){return j.uniq(j.flatten(arguments,!0))},j.intersection=function(n){var t=o.call(arguments,1);return j.filter(j.uniq(n),function(n){return j.every(t,function(t){return j.contains(t,n)})})},j.difference=function(n){var t=c.apply(e,o.call(arguments,1));return j.filter(n,function(n){return!j.contains(t,n)})},j.zip=function(){for(var n=j.max(j.pluck(arguments,"length").concat(0)),t=new Array(n),r=0;n>r;r++)t[r]=j.pluck(arguments,""+r);return t},j.object=function(n,t){if(null==n)return{};for(var r={},e=0,u=n.length;u>e;e++)t?r[n[e]]=t[e]:r[n[e][0]]=n[e][1];return r},j.indexOf=function(n,t,r){if(null==n)return-1;var e=0,u=n.length;if(r){if("number"!=typeof r)return e=j.sortedIndex(n,t),n[e]===t?e:-1;e=0>r?Math.max(0,u+r):r}if(y&&n.indexOf===y)return n.indexOf(t,r);for(;u>e;e++)if(n[e]===t)return e;return-1},j.lastIndexOf=function(n,t,r){if(null==n)return-1;var e=null!=r;if(b&&n.lastIndexOf===b)return e?n.lastIndexOf(t,r):n.lastIndexOf(t);for(var u=e?r:n.length;u--;)if(n[u]===t)return u;return-1},j.range=function(n,t,r){arguments.length<=1&&(t=n||0,n=0),r=arguments[2]||1;for(var e=Math.max(Math.ceil((t-n)/r),0),u=0,i=new Array(e);e>u;)i[u++]=n,n+=r;return i};var R=function(){};j.bind=function(n,t){var r,e;if(_&&n.bind===_)return _.apply(n,o.call(arguments,1));if(!j.isFunction(n))throw new TypeError;return r=o.call(arguments,2),e=function(){if(!(this instanceof e))return n.apply(t,r.concat(o.call(arguments)));R.prototype=n.prototype;var u=new R;R.prototype=null;var i=n.apply(u,r.concat(o.call(arguments)));return Object(i)===i?i:u}},j.partial=function(n){var t=o.call(arguments,1);return function(){for(var r=0,e=t.slice(),u=0,i=e.length;i>u;u++)e[u]===j&&(e[u]=arguments[r++]);for(;r<arguments.length;)e.push(arguments[r++]);return n.apply(this,e)}},j.bindAll=function(n){var t=o.call(arguments,1);if(0===t.length)throw new Error("bindAll must be passed function names");return A(t,function(t){n[t]=j.bind(n[t],n)}),n},j.memoize=function(n,t){var r={};return t||(t=j.identity),function(){var e=t.apply(this,arguments);return j.has(r,e)?r[e]:r[e]=n.apply(this,arguments)}},j.delay=function(n,t){var r=o.call(arguments,2);return setTimeout(function(){return n.apply(null,r)},t)},j.defer=function(n){return j.delay.apply(j,[n,1].concat(o.call(arguments,1)))},j.throttle=function(n,t,r){var e,u,i,a=null,o=0;r||(r={});var c=function(){o=r.leading===!1?0:j.now(),a=null,i=n.apply(e,u),e=u=null};return function(){var l=j.now();o||r.leading!==!1||(o=l);var f=t-(l-o);return e=this,u=arguments,0>=f?(clearTimeout(a),a=null,o=l,i=n.apply(e,u),e=u=null):a||r.trailing===!1||(a=setTimeout(c,f)),i}},j.debounce=function(n,t,r){var e,u,i,a,o,c=function(){var l=j.now()-a;t>l?e=setTimeout(c,t-l):(e=null,r||(o=n.apply(i,u),i=u=null))};return function(){i=this,u=arguments,a=j.now();var l=r&&!e;return e||(e=setTimeout(c,t)),l&&(o=n.apply(i,u),i=u=null),o}},j.once=function(n){var t,r=!1;return function(){return r?t:(r=!0,t=n.apply(this,arguments),n=null,t)}},j.wrap=function(n,t){return j.partial(t,n)},j.compose=function(){var n=arguments;return function(){for(var t=arguments,r=n.length-1;r>=0;r--)t=[n[r].apply(this,t)];return t[0]}},j.after=function(n,t){return function(){return--n<1?t.apply(this,arguments):void 0}},j.keys=function(n){if(!j.isObject(n))return[];if(w)return w(n);var t=[];for(var r in n)j.has(n,r)&&t.push(r);return t},j.values=function(n){for(var t=j.keys(n),r=t.length,e=new Array(r),u=0;r>u;u++)e[u]=n[t[u]];return e},j.pairs=function(n){for(var t=j.keys(n),r=t.length,e=new Array(r),u=0;r>u;u++)e[u]=[t[u],n[t[u]]];return e},j.invert=function(n){for(var t={},r=j.keys(n),e=0,u=r.length;u>e;e++)t[n[r[e]]]=r[e];return t},j.functions=j.methods=function(n){var t=[];for(var r in n)j.isFunction(n[r])&&t.push(r);return t.sort()},j.extend=function(n){return A(o.call(arguments,1),function(t){if(t)for(var r in t)n[r]=t[r]}),n},j.pick=function(n){var t={},r=c.apply(e,o.call(arguments,1));return A(r,function(r){r in n&&(t[r]=n[r])}),t},j.omit=function(n){var t={},r=c.apply(e,o.call(arguments,1));for(var u in n)j.contains(r,u)||(t[u]=n[u]);return t},j.defaults=function(n){return A(o.call(arguments,1),function(t){if(t)for(var r in t)n[r]===void 0&&(n[r]=t[r])}),n},j.clone=function(n){return j.isObject(n)?j.isArray(n)?n.slice():j.extend({},n):n},j.tap=function(n,t){return t(n),n};var S=function(n,t,r,e){if(n===t)return 0!==n||1/n==1/t;if(null==n||null==t)return n===t;n instanceof j&&(n=n._wrapped),t instanceof j&&(t=t._wrapped);var u=l.call(n);if(u!=l.call(t))return!1;switch(u){case"[object String]":return n==String(t);case"[object Number]":return n!=+n?t!=+t:0==n?1/n==1/t:n==+t;case"[object Date]":case"[object Boolean]":return+n==+t;case"[object RegExp]":return n.source==t.source&&n.global==t.global&&n.multiline==t.multiline&&n.ignoreCase==t.ignoreCase}if("object"!=typeof n||"object"!=typeof t)return!1;for(var i=r.length;i--;)if(r[i]==n)return e[i]==t;var a=n.constructor,o=t.constructor;if(a!==o&&!(j.isFunction(a)&&a instanceof a&&j.isFunction(o)&&o instanceof o)&&"constructor"in n&&"constructor"in t)return!1;r.push(n),e.push(t);var c=0,f=!0;if("[object Array]"==u){if(c=n.length,f=c==t.length)for(;c--&&(f=S(n[c],t[c],r,e)););}else{for(var s in n)if(j.has(n,s)&&(c++,!(f=j.has(t,s)&&S(n[s],t[s],r,e))))break;if(f){for(s in t)if(j.has(t,s)&&!c--)break;f=!c}}return r.pop(),e.pop(),f};j.isEqual=function(n,t){return S(n,t,[],[])},j.isEmpty=function(n){if(null==n)return!0;if(j.isArray(n)||j.isString(n))return 0===n.length;for(var t in n)if(j.has(n,t))return!1;return!0},j.isElement=function(n){return!(!n||1!==n.nodeType)},j.isArray=x||function(n){return"[object Array]"==l.call(n)},j.isObject=function(n){return n===Object(n)},A(["Arguments","Function","String","Number","Date","RegExp"],function(n){j["is"+n]=function(t){return l.call(t)=="[object "+n+"]"}}),j.isArguments(arguments)||(j.isArguments=function(n){return!(!n||!j.has(n,"callee"))}),"function"!=typeof/./&&(j.isFunction=function(n){return"function"==typeof n}),j.isFinite=function(n){return isFinite(n)&&!isNaN(parseFloat(n))},j.isNaN=function(n){return j.isNumber(n)&&n!=+n},j.isBoolean=function(n){return n===!0||n===!1||"[object Boolean]"==l.call(n)},j.isNull=function(n){return null===n},j.isUndefined=function(n){return n===void 0},j.has=function(n,t){return f.call(n,t)},j.noConflict=function(){return n._=t,this},j.identity=function(n){return n},j.constant=function(n){return function(){return n}},j.property=function(n){return function(t){return t[n]}},j.matches=function(n){return function(t){if(t===n)return!0;for(var r in n)if(n[r]!==t[r])return!1;return!0}},j.times=function(n,t,r){for(var e=Array(Math.max(0,n)),u=0;n>u;u++)e[u]=t.call(r,u);return e},j.random=function(n,t){return null==t&&(t=n,n=0),n+Math.floor(Math.random()*(t-n+1))},j.now=Date.now||function(){return(new Date).getTime()};var T={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};T.unescape=j.invert(T.escape);var I={escape:new RegExp("["+j.keys(T.escape).join("")+"]","g"),unescape:new RegExp("("+j.keys(T.unescape).join("|")+")","g")};j.each(["escape","unescape"],function(n){j[n]=function(t){return null==t?"":(""+t).replace(I[n],function(t){return T[n][t]})}}),j.result=function(n,t){if(null==n)return void 0;var r=n[t];return j.isFunction(r)?r.call(n):r},j.mixin=function(n){A(j.functions(n),function(t){var r=j[t]=n[t];j.prototype[t]=function(){var n=[this._wrapped];return a.apply(n,arguments),z.call(this,r.apply(j,n))}})};var N=0;j.uniqueId=function(n){var t=++N+"";return n?n+t:t},j.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var q=/(.)^/,B={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},D=/\\|'|\r|\n|\t|\u2028|\u2029/g;j.template=function(n,t,r){var e;r=j.defaults({},r,j.templateSettings);var u=new RegExp([(r.escape||q).source,(r.interpolate||q).source,(r.evaluate||q).source].join("|")+"|$","g"),i=0,a="__p+='";n.replace(u,function(t,r,e,u,o){return a+=n.slice(i,o).replace(D,function(n){return"\\"+B[n]}),r&&(a+="'+\n((__t=("+r+"))==null?'':_.escape(__t))+\n'"),e&&(a+="'+\n((__t=("+e+"))==null?'':__t)+\n'"),u&&(a+="';\n"+u+"\n__p+='"),i=o+t.length,t}),a+="';\n",r.variable||(a="with(obj||{}){\n"+a+"}\n"),a="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{e=new Function(r.variable||"obj","_",a)}catch(o){throw o.source=a,o}if(t)return e(t,j);var c=function(n){return e.call(this,n,j)};return c.source="function("+(r.variable||"obj")+"){\n"+a+"}",c},j.chain=function(n){return j(n).chain()};var z=function(n){return this._chain?j(n).chain():n};j.mixin(j),A(["pop","push","reverse","shift","sort","splice","unshift"],function(n){var t=e[n];j.prototype[n]=function(){var r=this._wrapped;return t.apply(r,arguments),"shift"!=n&&"splice"!=n||0!==r.length||delete r[0],z.call(this,r)}}),A(["concat","join","slice"],function(n){var t=e[n];j.prototype[n]=function(){return z.call(this,t.apply(this._wrapped,arguments))}}),j.extend(j.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}}),"function"==typeof define&&define.amd&&define("underscore",[],function(){return j})}).call(this);
;;(function(win,_){var array=[];var push=array.push;var slice=array.slice;var splice=array.splice;var Events={on:function(name,callback,context){if(!eventsApi(this,'on',name,[callback,context])||!callback)return this;this._events||(this._events={});var events=this._events[name]||(this._events[name]=[]);events.push({callback:callback,context:context,ctx:context||this});return this;},once:function(name,callback,context){if(!eventsApi(this,'once',name,[callback,context])||!callback)return this;var self=this;var once=_.once(function(){self.off(name,once);callback.apply(this,arguments);});once._callback=callback;return this.on(name,once,context);},off:function(name,callback,context){var retain,ev,events,names,i,l,j,k;if(!this._events||!eventsApi(this,'off',name,[callback,context]))return this;if(!name&&!callback&&!context){this._events=void 0;return this;}
names=name?[name]:_.keys(this._events);for(i=0,l=names.length;i<l;i++){name=names[i];if(events=this._events[name]){this._events[name]=retain=[];if(callback||context){for(j=0,k=events.length;j<k;j++){ev=events[j];if((callback&&callback!==ev.callback&&callback!==ev.callback._callback)||(context&&context!==ev.context)){retain.push(ev);}}}
if(!retain.length)delete this._events[name];}}
return this;},trigger:function(name){if(!this._events)return this;var args=slice.call(arguments,1);if(!eventsApi(this,'trigger',name,args))return this;var events=this._events[name];var allEvents=this._events.all;if(events)triggerEvents(events,args);if(allEvents)triggerEvents(allEvents,arguments);return this;},stopListening:function(obj,name,callback){var listeningTo=this._listeningTo;if(!listeningTo)return this;var remove=!name&&!callback;if(!callback&&typeof name==='object')callback=this;if(obj)(listeningTo={})[obj._listenId]=obj;for(var id in listeningTo){obj=listeningTo[id];obj.off(name,callback,this);if(remove||_.isEmpty(obj._events))delete this._listeningTo[id];}
return this;}};var eventSplitter=/\s+/;var eventsApi=function(obj,action,name,rest){if(!name)return true;if(typeof name==='object'){for(var key in name){obj[action].apply(obj,[key,name[key]].concat(rest));}
return false;}
if(eventSplitter.test(name)){var names=name.split(eventSplitter);for(var i=0,l=names.length;i<l;i++){obj[action].apply(obj,[names[i]].concat(rest));}
return false;}
return true;};var triggerEvents=function(events,args){var ev,i=-1,l=events.length,a1=args[0],a2=args[1],a3=args[2];switch(args.length){case 0:while(++i<l)(ev=events[i]).callback.call(ev.ctx);return;case 1:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1);return;case 2:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1,a2);return;case 3:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1,a2,a3);return;default:while(++i<l)(ev=events[i]).callback.apply(ev.ctx,args);return;}};var listenMethods={listenTo:'on',listenToOnce:'once'};_.each(listenMethods,function(implementation,method){Events[method]=function(obj,name,callback){var listeningTo=this._listeningTo||(this._listeningTo={});var id=obj._listenId||(obj._listenId=_.uniqueId('l'));listeningTo[id]=obj;if(!callback&&typeof name==='object')callback=this;obj[implementation](name,callback,this);return this;};});Events.bind=Events.on;Events.unbind=Events.off;function Event(){};Event.prototype=Events;win.Event=Event;win.Events=Events;})(window,_);;(function(factory){'use strict';if(typeof define==='function'&&define.amd){define(['jquery'],factory);}else if(typeof exports==='object'&&typeof require==='function'){factory(require('jquery'));}else{factory(jQuery);}}(function($){'use strict';var
utils=(function(){return{escapeRegExChars:function(value){return value.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");},createNode:function(containerClass){var div=document.createElement('div');div.className=containerClass;div.style.position='absolute';div.style.display='none';return div;}};}()),keys={ESC:27,TAB:9,RETURN:13,LEFT:37,UP:38,RIGHT:39,DOWN:40};function Autocomplete(el,options){var noop=function(){},that=this,defaults={ajaxSettings:{},autoSelectFirst:false,appendTo:document.body,serviceUrl:null,lookup:null,onSelect:null,width:'auto',minChars:1,maxHeight:300,deferRequestBy:0,params:{},formatResult:Autocomplete.formatResult,delimiter:null,zIndex:9999,type:'GET',noCache:false,onSearchStart:noop,onSearchComplete:noop,onSearchError:noop,containerClass:'autocomplete-suggestions',tabDisabled:false,dataType:'text',currentRequest:null,triggerSelectOnValidInput:true,preventBadQueries:true,lookupFilter:function(suggestion,originalQuery,queryLowerCase){return suggestion.value.toLowerCase().indexOf(queryLowerCase)!==-1;},paramName:'query',transformResult:function(response){return typeof response==='string'?$.parseJSON(response):response;},showNoSuggestionNotice:false,noSuggestionNotice:'No results',orientation:'bottom',forceFixPosition:false};that.element=el;that.el=$(el);that.suggestions=[];that.badQueries=[];that.selectedIndex=-1;that.currentValue=that.element.value;that.intervalId=0;that.cachedResponse={};that.onChangeInterval=null;that.onChange=null;that.isLocal=false;that.suggestionsContainer=null;that.noSuggestionsContainer=null;that.options=$.extend({},defaults,options);that.classes={selected:'autocomplete-selected',suggestion:'autocomplete-suggestion'};that.hint=null;that.hintValue='';that.selection=null;that.initialize();that.setOptions(options);}
Autocomplete.utils=utils;$.PkgAutocomplete=Autocomplete;Autocomplete.formatResult=function(suggestion,currentValue){var pattern='('+utils.escapeRegExChars(currentValue)+')';return suggestion.value.replace(new RegExp(pattern,'gi'),'<strong>$1<\/strong>');};Autocomplete.prototype={killerFn:null,initialize:function(){var that=this,suggestionSelector='.'+that.classes.suggestion,selected=that.classes.selected,options=that.options,container;that.element.setAttribute('autocomplete','off');that.killerFn=function(e){if($(e.target).closest('.'+that.options.containerClass).length===0){that.killSuggestions();that.disableKillerFn();}};that.noSuggestionsContainer=$('<div class="autocomplete-no-suggestion"></div>').html(this.options.noSuggestionNotice).get(0);that.suggestionsContainer=Autocomplete.utils.createNode(options.containerClass);container=$(that.suggestionsContainer);container.appendTo(options.appendTo);if(options.width!=='auto'){container.width(options.width);}
container.on('mouseover.autocomplete',suggestionSelector,function(){that.activate($(this).data('index'));});container.on('mouseout.autocomplete',function(){that.selectedIndex=-1;container.children('.'+selected).removeClass(selected);});container.on('click.autocomplete',suggestionSelector,function(){that.select($(this).data('index'));});that.fixPositionCapture=function(){if(that.visible){that.fixPosition();}};$(window).on('resize.autocomplete',that.fixPositionCapture);that.el.on('keydown.autocomplete',function(e){that.onKeyPress(e);});that.el.on('keyup.autocomplete',function(e){that.onKeyUp(e);});that.el.on('blur.autocomplete',function(){that.onBlur();});that.el.on('focus.autocomplete',function(){that.onFocus();});that.el.on('change.autocomplete',function(e){that.onKeyUp(e);});},onFocus:function(){var that=this;that.fixPosition();if(that.options.minChars<=that.el.val().length){that.onValueChange();}},onBlur:function(){this.enableKillerFn();},setOptions:function(suppliedOptions){var that=this,options=that.options;$.extend(options,suppliedOptions);that.isLocal=$.isArray(options.lookup);if(that.isLocal){options.lookup=that.verifySuggestionsFormat(options.lookup);}
options.orientation=that.validateOrientation(options.orientation,'bottom');$(that.suggestionsContainer).css({'max-height':options.maxHeight+'px','width':options.width+'px','z-index':options.zIndex});},clearCache:function(){this.cachedResponse={};this.badQueries=[];},clear:function(){this.clearCache();this.currentValue='';this.suggestions=[];},disable:function(){var that=this;that.disabled=true;clearInterval(that.onChangeInterval);if(that.currentRequest){that.currentRequest.abort();}},enable:function(){this.disabled=false;},fixPosition:function(){var that=this,$container=$(that.suggestionsContainer),containerParent=$container.parent().get(0);if(containerParent!==document.body&&!that.options.forceFixPosition)
return;var orientation=that.options.orientation,containerHeight=$container.outerHeight(),height=that.el.outerHeight(),offset=that.el.offset(),styles={'top':offset.top,'left':offset.left};if(orientation=='auto'){var viewPortHeight=$(window).height(),scrollTop=$(window).scrollTop(),topOverflow=-scrollTop+offset.top-containerHeight,bottomOverflow=scrollTop+viewPortHeight-(offset.top+height+containerHeight);orientation=(Math.max(topOverflow,bottomOverflow)===topOverflow)?'top':'bottom';}
if(orientation==='top'){styles.top+=-containerHeight;}else{styles.top+=height;}
if(containerParent!==document.body){var opacity=$container.css('opacity'),parentOffsetDiff;if(!that.visible){$container.css('opacity',0).show();}
parentOffsetDiff=$container.offsetParent().offset();styles.top-=parentOffsetDiff.top;styles.left-=parentOffsetDiff.left;if(!that.visible){$container.css('opacity',opacity).hide();}}
if(that.options.width==='auto'){styles.width=(that.el.outerWidth()-2)+'px';}
$container.css(styles);},enableKillerFn:function(){var that=this;$(document).on('click.autocomplete',that.killerFn);},disableKillerFn:function(){var that=this;$(document).off('click.autocomplete',that.killerFn);},killSuggestions:function(){var that=this;that.stopKillSuggestions();that.intervalId=window.setInterval(function(){that.hide();that.stopKillSuggestions();},50);},stopKillSuggestions:function(){window.clearInterval(this.intervalId);},isCursorAtEnd:function(){var that=this,valLength=that.el.val().length,selectionStart=that.element.selectionStart,range;if(typeof selectionStart==='number'){return selectionStart===valLength;}
if(document.selection){range=document.selection.createRange();range.moveStart('character',-valLength);return valLength===range.text.length;}
return true;},onKeyPress:function(e){var that=this;if(!that.disabled&&!that.visible&&e.which===keys.DOWN&&that.currentValue){that.suggest();return;}
if(that.disabled||!that.visible){return;}
switch(e.which){case keys.ESC:that.el.val(that.currentValue);that.hide();break;case keys.RIGHT:if(that.hint&&that.options.onHint&&that.isCursorAtEnd()){that.selectHint();break;}
return;case keys.TAB:if(that.hint&&that.options.onHint){that.selectHint();return;}
case keys.RETURN:if(that.selectedIndex===-1){that.hide();return;}
that.select(that.selectedIndex);if(e.which===keys.TAB&&that.options.tabDisabled===false){return;}
break;case keys.UP:that.moveUp();break;case keys.DOWN:that.moveDown();break;default:return;}
e.stopImmediatePropagation();e.preventDefault();},onKeyUp:function(e){var that=this;if(that.disabled){return;}
switch(e.which){case keys.UP:case keys.DOWN:return;}
clearInterval(that.onChangeInterval);if(that.currentValue!==that.el.val()){that.findBestHint();if(that.options.deferRequestBy>0){that.onChangeInterval=setInterval(function(){that.onValueChange();},that.options.deferRequestBy);}else{that.onValueChange();}}},onValueChange:function(){var that=this,options=that.options,value=that.el.val(),query=that.getQuery(value),index;if(that.selection&&that.currentValue!==query){that.selection=null;(options.onInvalidateSelection||$.noop).call(that.element);}
clearInterval(that.onChangeInterval);that.currentValue=value;that.selectedIndex=-1;if(options.triggerSelectOnValidInput){index=that.findSuggestionIndex(query);if(index!==-1){that.select(index);return;}}
if(query.length<options.minChars){that.hide();}else{that.getSuggestions(query);}},findSuggestionIndex:function(query){var that=this,index=-1,queryLowerCase=query.toLowerCase();$.each(that.suggestions,function(i,suggestion){if(suggestion.value.toLowerCase()===queryLowerCase){index=i;return false;}});return index;},getQuery:function(value){var delimiter=this.options.delimiter,parts;if(!delimiter){return value;}
parts=value.split(delimiter);return $.trim(parts[parts.length-1]);},getSuggestionsLocal:function(query){var that=this,options=that.options,queryLowerCase=query.toLowerCase(),filter=options.lookupFilter,limit=parseInt(options.lookupLimit,10),data;data={suggestions:$.grep(options.lookup,function(suggestion){return filter(suggestion,query,queryLowerCase);})};if(limit&&data.suggestions.length>limit){data.suggestions=data.suggestions.slice(0,limit);}
return data;},getSuggestions:function(q){var response,that=this,options=that.options,serviceUrl=options.serviceUrl,params,cacheKey,ajaxSettings;options.params[options.paramName]=q;params=options.ignoreParams?null:options.params;if(options.onSearchStart.call(that.element,options.params)===false){return;}
if(that.isLocal){response=that.getSuggestionsLocal(q);}else{if($.isFunction(serviceUrl)){serviceUrl=serviceUrl.call(that.element,q);}
cacheKey=serviceUrl+'?'+$.param(params||{});response=that.cachedResponse[cacheKey];}
if(response&&$.isArray(response.suggestions)){that.suggestions=response.suggestions;that.suggest();options.onSearchComplete.call(that.element,q,response.suggestions);}else if(!that.isBadQuery(q)){if(that.currentRequest){that.currentRequest.abort();}
ajaxSettings={url:serviceUrl,data:params,type:options.type,dataType:options.dataType};$.extend(ajaxSettings,options.ajaxSettings);that.currentRequest=$.ajax(ajaxSettings).done(function(data){var result;that.currentRequest=null;result=options.transformResult(data);that.processResponse(result,q,cacheKey);options.onSearchComplete.call(that.element,q,result.suggestions);}).fail(function(jqXHR,textStatus,errorThrown){options.onSearchError.call(that.element,q,jqXHR,textStatus,errorThrown);});}else{options.onSearchComplete.call(that.element,q,[]);}},isBadQuery:function(q){if(!this.options.preventBadQueries){return false;}
var badQueries=this.badQueries,i=badQueries.length;while(i--){if(q.indexOf(badQueries[i])===0){return true;}}
return false;},hide:function(){var that=this;that.visible=false;that.selectedIndex=-1;clearInterval(that.onChangeInterval);$(that.suggestionsContainer).hide();that.signalHint(null);},suggest:function(){if(this.suggestions.length===0){this.options.showNoSuggestionNotice?this.noSuggestions():this.hide();return;}
var that=this,options=that.options,groupBy=options.groupBy,formatResult=options.formatResult,value=that.getQuery(that.currentValue),className=that.classes.suggestion,classSelected=that.classes.selected,container=$(that.suggestionsContainer),noSuggestionsContainer=$(that.noSuggestionsContainer),beforeRender=options.beforeRender,html='',category,formatGroup=function(suggestion,index){var currentCategory=suggestion.data[groupBy];if(category===currentCategory){return'';}
category=currentCategory;return'<div class="autocomplete-group"><strong>'+category+'</strong></div>';},index;if(options.triggerSelectOnValidInput){index=that.findSuggestionIndex(value);if(index!==-1){that.select(index);return;}}
$.each(that.suggestions,function(i,suggestion){if(groupBy){html+=formatGroup(suggestion,value,i);}
html+='<div class="'+className+'" data-index="'+i+'">'+formatResult(suggestion,value)+'</div>';});this.adjustContainerWidth();noSuggestionsContainer.detach();container.html(html);if(options.autoSelectFirst){that.selectedIndex=0;container.children().first().addClass(classSelected);}
if($.isFunction(beforeRender)){beforeRender.call(that.element,container);}
that.fixPosition();container.show();that.visible=true;that.findBestHint();},noSuggestions:function(){var that=this,container=$(that.suggestionsContainer),noSuggestionsContainer=$(that.noSuggestionsContainer);this.adjustContainerWidth();noSuggestionsContainer.detach();container.empty();container.append(noSuggestionsContainer);that.fixPosition();container.show();that.visible=true;},adjustContainerWidth:function(){var that=this,options=that.options,width,container=$(that.suggestionsContainer);if(options.width==='auto'){width=that.el.outerWidth()-2;container.width(width>0?width:300);}},findBestHint:function(){var that=this,value=that.el.val().toLowerCase(),bestMatch=null;if(!value){return;}
$.each(that.suggestions,function(i,suggestion){var foundMatch=suggestion.value.toLowerCase().indexOf(value)===0;if(foundMatch){bestMatch=suggestion;}
return!foundMatch;});that.signalHint(bestMatch);},signalHint:function(suggestion){var hintValue='',that=this;if(suggestion){hintValue=that.currentValue+suggestion.value.substr(that.currentValue.length);}
if(that.hintValue!==hintValue){that.hintValue=hintValue;that.hint=suggestion;(this.options.onHint||$.noop)(hintValue);}},verifySuggestionsFormat:function(suggestions){if(suggestions.length&&typeof suggestions[0]==='string'){return $.map(suggestions,function(value){return{value:value,data:null};});}
return suggestions;},validateOrientation:function(orientation,fallback){orientation=$.trim(orientation||'').toLowerCase();if($.inArray(orientation,['auto','bottom','top'])===-1){orientation=fallback;}
return orientation;},processResponse:function(result,originalQuery,cacheKey){var that=this,options=that.options;result.suggestions=that.verifySuggestionsFormat(result.suggestions);if(!options.noCache){that.cachedResponse[cacheKey]=result;if(options.preventBadQueries&&result.suggestions.length===0){that.badQueries.push(originalQuery);}}
if(originalQuery!==that.getQuery(that.currentValue)){return;}
that.suggestions=result.suggestions;that.suggest();},activate:function(index){var that=this,activeItem,selected=that.classes.selected,container=$(that.suggestionsContainer),children=container.find('.'+that.classes.suggestion);container.find('.'+selected).removeClass(selected);that.selectedIndex=index;if(that.selectedIndex!==-1&&children.length>that.selectedIndex){activeItem=children.get(that.selectedIndex);$(activeItem).addClass(selected);return activeItem;}
return null;},selectHint:function(){var that=this,i=$.inArray(that.hint,that.suggestions);that.select(i);},select:function(i){var that=this;that.hide();that.onSelect(i);},moveUp:function(){var that=this;if(that.selectedIndex===-1){return;}
if(that.selectedIndex===0){$(that.suggestionsContainer).children().first().removeClass(that.classes.selected);that.selectedIndex=-1;that.el.val(that.currentValue);that.findBestHint();return;}
that.adjustScroll(that.selectedIndex-1);},moveDown:function(){var that=this;if(that.selectedIndex===(that.suggestions.length-1)){return;}
that.adjustScroll(that.selectedIndex+1);},adjustScroll:function(index){var that=this,activeItem=that.activate(index),offsetTop,upperBound,lowerBound,heightDelta=25;if(!activeItem){return;}
offsetTop=activeItem.offsetTop;upperBound=$(that.suggestionsContainer).scrollTop();lowerBound=upperBound+that.options.maxHeight-heightDelta;if(offsetTop<upperBound){$(that.suggestionsContainer).scrollTop(offsetTop);}else if(offsetTop>lowerBound){$(that.suggestionsContainer).scrollTop(offsetTop-that.options.maxHeight+heightDelta);}
that.el.val(that.getValue(that.suggestions[index].value));that.signalHint(null);},onSelect:function(index){var that=this,onSelectCallback=that.options.onSelect,suggestion=that.suggestions[index];that.currentValue=that.getValue(suggestion.value);if(that.currentValue!==that.el.val()){that.el.val(that.currentValue);}
that.signalHint(null);that.suggestions=[];that.selection=suggestion;if($.isFunction(onSelectCallback)){onSelectCallback.call(that.element,suggestion);}},getValue:function(value){var that=this,delimiter=that.options.delimiter,currentValue,parts;if(!delimiter){return value;}
currentValue=that.currentValue;parts=currentValue.split(delimiter);if(parts.length===1){return value;}
return currentValue.substr(0,currentValue.length-parts[parts.length-1].length)+value;},dispose:function(){var that=this;that.el.off('.autocomplete').removeData('autocomplete');that.disableKillerFn();$(window).off('resize.autocomplete',that.fixPositionCapture);$(that.suggestionsContainer).remove();}};$.fn.pkgautocomplete=$.fn.pkgdevbridgeAutocomplete=function(options,args){var dataKey='autocomplete';if(arguments.length===0){return this.first().data(dataKey);}
return this.each(function(){var inputElement=$(this),instance=inputElement.data(dataKey);if(typeof options==='string'){if(instance&&typeof instance[options]==='function'){instance[options](args);}}else{if(instance&&instance.dispose){instance.dispose();}
instance=new Autocomplete(this,options);inputElement.data(dataKey,instance);}});};}));;(function($){var dateEles=[];if(!Array.prototype.indexOf){Array.prototype.indexOf=function(elt){var len=this.length>>>0;var from=Number(arguments[1])||0;from=(from<0)?Math.ceil(from):Math.floor(from);if(from<0)
from+=len;for(;from<len;from++){if(from in this&&this[from]===elt)
return from;}
return-1;};}
function hideAllDate(){for(var i=0;i<dateEles.length;i++){dateEles[i].hide();}}
$.fn.TN_pkdate=function(settings){settings=jQuery.extend({wrap:'#wrap',dateW:'tnDateW_train',tnStartDate:'date_t_pre',tnEndDate:'date_t_next',currentObj:this,leaveDate:21},settings);var startDateArea=$(this[0]);var dateWObj;var tnStartDateObj;var tnEndDateObj;var nowTarget;var monthnames=new Array("1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月");var monthdays,todayDate,thisday,thismonth,thisdate,thisyear;var fthisday,fthismonth,fthisyear,ftodayDate;var festivalMap={"solar":{"0101":"元旦","0214":"情人","0308":"妇女","0501":"劳动","0601":"儿童","0910":"教师","1001":"国庆","1225":"圣诞"},"lunar":{"2015":["","","","","","","0927"],"2016":["0207","0208","0222","0404","0609","0809","0915"],"2017":["0127","0128","0211","0404","0530","0828","1004"],"2018":["0215","0216","0302","0405","0618","0817","0924"],"2019":["0204","0205","0219","0405","0607","0807","0913"],"2020":["0124","0125","0208","0404","0625","0825","1001"]},"lunarFestivals":["除夕","春节","元宵","清明","端午","七夕","中秋"]};function _initialize(){stateC(startDateArea);_initDate();dateWObj=$('<div class="'+settings.dateW+'"></div>').appendTo(settings.wrap);dateWObj.mousedown(function(event){event.stopPropagation();});dateWObj.hide();dateEles.push(dateWObj);tnStartDateObj=$('<div class="'+settings.tnStartDate+'"></div>').appendTo(dateWObj);tnEndDateObj=$('<div class="'+settings.tnEndDate+'"></div>').appendTo(dateWObj);dateWObj.delegate('.tdCobj','mouseover',function(){$(this).addClass('tdCobjS');}).delegate('.tdCobj','mouseout',function(){$(this).removeClass('tdCobjS');}).undelegate('click').delegate('.tdCobj','click',function(){nowTarget.val($(this).attr('data-id'));var selectWeek=nowTarget.val();if(settings.onSelect){settings.onSelect(selectWeek,nowTarget);}
nowTarget.css({'color':'#000'});dateWObj.hide();var nowWeek=getWeekday(selectWeek);$(document).unbind('mousedown',hideDateObj);});dateWObj.delegate('a.pre_link','click',function(){return MoveDate('pre')});dateWObj.delegate('a.next_link','click',function(){return MoveDate('next')});startDateArea.focus(function(){focusInputProcess($(this));}).blur(function(){blurTxtProcess($(this));}).keydown(function(){return false;}).mousedown(function(event){}).bind('contextmenu',function(e){e.preventDefault();});$(window).resize(function(){if(dateWObj.is(':visible'))posDate();});};function GetDateStr(pdate,AddDayCount){var dd=pdate;dd.setDate(dd.getDate()+AddDayCount);var y=dd.getYear();y=y%100;y=((y<50)?(2000+y):(1900+y));var m=dd.getMonth()+1;var d=dd.getDate();return y+"-"+adjustNumber(m)+"-"+adjustNumber(d);}
function stateC(obj){if(obj.val()=='yyyy-mm-dd'||obj.val()==''){if(obj.val()=='')obj.val('yyyy-mm-dd');obj.css({'color':'#999'});}
else{}}
function focusInputProcess(obj){hideAllDate();nowTarget=obj;var ptip=false;if((obj.val()=='yyyy-mm-dd'&&nowTarget[0]==startDateArea[0])||(obj.val()=='yyyy-mm-dd'&&startDateArea.val()=='yyyy-mm-dd')){obj.val('').css({'color':'#000'});ftodayDate=thisdate;fthisday=thisday;fthismonth=thismonth;fthisyear=thisyear;}
else if(nowTarget[0]==startDateArea[0]){var tArr=obj.val().split('-');var gddayDate=new Date(tArr[0],tArr[1]-1,tArr[2]);fthisday=gddayDate.getDay();fthismonth=gddayDate.getMonth();fthisyear=gddayDate.getYear();fthisyear=fthisyear%100;fthisyear=((fthisyear<50)?(2000+fthisyear):(1900+fthisyear));ftodayDate=gddayDate.getDate();}
formDate(ptip);posDate();dateWObj.show();preDocEvent();}
function formDate(ctip){var nday=fthisday;var nmonth=fthismonth;var nyear=fthisyear;var ndate=ftodayDate;var nextMonthObj=_getPreAndNextMoth('n');fthisday=nextMonthObj.xDay;fthismonth=nextMonthObj.xMonth;fthisyear=nextMonthObj.xYear;ftodayDate=1;var outStr,outStr2;if((nyear==thisyear&&nmonth==thismonth)||ctip){outStr=('<div class="date_t_b"><div class="pre_month"><span class="pre_link">&lt;</span>'+nyear+"年"+monthnames[nmonth]+'</div>')+_createDate(nyear,nmonth,ndate,nday);}
else{outStr=('<div class="date_t_b"><div class="pre_month"><a href="#" class="pre_link">&lt;</a>'+nyear+"年"+monthnames[nmonth]+'</div>')+_createDate(nyear,nmonth,ndate,nday);}
outStr2=('<div class="date_t_b"><div class="next_month"><a href="#" class="next_link">&gt;</a>'+nextMonthObj.xYear+"年"+monthnames[nextMonthObj.xMonth]+'</div>')+_createDate(nextMonthObj.xYear,nextMonthObj.xMonth,1,nextMonthObj.xDay);tnStartDateObj.html(outStr);tnEndDateObj.html(outStr2);bl_height();}
function posDate(){var wrapOffset=settings.wrap.offset();var pos=nowTarget.offset();var posL=pos.left;var posT=pos.top+nowTarget.outerHeight()+1;dateWObj.css({'left':posL-wrapOffset.left,'top':posT-wrapOffset.top});}
function blurTxtProcess(obj){if(obj.val()==''){obj.val('yyyy-mm-dd');obj.css({'color':'#999'});}
else if(obj.val()!='yyyy-mm-dd'){obj.css({'color':'#000'});}}
function _initDate(){todayDate=new Date();var tArr=GetDateStr(todayDate,0).split('-');todayDate=new Date(tArr[0],tArr[1]-1,tArr[2]);thisday=todayDate.getDay();thismonth=todayDate.getMonth();thisdate=todayDate.getDate();thisyear=todayDate.getYear();thisyear=thisyear%100;thisyear=((thisyear<50)?(2000+thisyear):(1900+thisyear));ftodayDate=thisdate;fthisday=thisday;fthismonth=thismonth;fthisyear=thisyear;}
function preDocEvent(){$(document).unbind('mousedown',hideDateObj);$(document).mousedown(hideDateObj);}
function bl_height(){var sNum=tnStartDateObj.find('tr').length;var eNum=tnEndDateObj.find('tr').length;var astr='<tr><td>&nbsp;</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>';if(sNum>eNum){tnEndDateObj.find('table').append(astr);}
else if(eNum>sNum){tnStartDateObj.find('table').append(astr);}
else{}}
function hideDateObj(){$(document).unbind('mousedown',hideDateObj);dateWObj.hide();initTxt(startDateArea);}
function initTxt(obj){if(obj.val()==''){obj.val('yyyy-mm-dd');obj.css({'color':'#999'});}
else if(obj.val()!='yyyy-mm-dd'){obj.css({'color':'#000'});}
else{}}
function MoveDate(direction){var nextMonthObj;var nextMonthObj2;if(direction=='pre'){nextMonthObj=_getPreAndNextMoth('p');fthisday=nextMonthObj.xDay;fthismonth=nextMonthObj.xMonth;fthisyear=nextMonthObj.xYear;nextMonthObj2=_getPreAndNextMoth('p');var outStr,outStr2;if(nextMonthObj2.xYear==thisyear&&nextMonthObj2.xMonth==thismonth){outStr=_pickDateStr(thisyear,thismonth,thisyear,thismonth,thisdate,thisday,'p',true,true);outStr2=_pickDateStr(fthisyear,fthismonth,fthisyear,fthismonth,1,fthisday,'n',true,true);}
else{outStr=_pickDateStr(nextMonthObj2.xYear,nextMonthObj2.xMonth,nextMonthObj2.xYear,nextMonthObj2.xMonth,1,nextMonthObj2.xDay,'p',false,true);outStr2=_pickDateStr(fthisyear,fthismonth,fthisyear,fthismonth,1,fthisday,'n',true,true);}
tnStartDateObj.html(outStr);tnEndDateObj.html(outStr2);}
else{nextMonthObj=_getPreAndNextMoth('n');var outStr,outStr2;outStr=_pickDateStr(fthisyear,fthismonth,fthisyear,fthismonth,1,fthisday,'p',false,false);outStr2=_pickDateStr(nextMonthObj.xYear,nextMonthObj.xMonth,nextMonthObj.xYear,nextMonthObj.xMonth,1,nextMonthObj.xDay,'n',true,false);tnStartDateObj.html(outStr);tnEndDateObj.html(outStr2);}
bl_height();fthisday=nextMonthObj.xDay;fthismonth=nextMonthObj.xMonth;fthisyear=nextMonthObj.xYear;return false;}
function _pickDateStr(xyear,xmonth,cyear,cmonth,cdate,cday,PNtip,btip,qtip){var outStr='';var stip=false;if(PNtip=='p'){outStr+='<div class="date_t_b"><div class="pre_month">';if(btip||stip){outStr+='<span class="pre_link">&lt;</span>';}
else{outStr+='<a href="#" class="pre_link">&lt;</a>';}}
else{outStr+='<div class="date_t_b"><div class="next_month"><a href="#" class="next_link">&gt;</a>';}
outStr+=(xyear+"年"+monthnames[xmonth]+'</div>'+_createDate(cyear,cmonth,cdate,cday));return outStr;}
function _getPreAndNextMoth(pntip){var gdYear=0;var gdMonth=0;if(pntip=='n'){if(fthismonth<11){gdMonth=fthismonth+1;gdYear=fthisyear;}
else{gdMonth=0;gdYear=fthisyear+1;}}
else{if(fthismonth>0){gdMonth=fthismonth-1;gdYear=fthisyear;}
else{gdMonth=11;gdYear=fthisyear-1;}}
var gddayDate=new Date(gdYear,gdMonth,1);var fthisgdday=gddayDate.getDay();var fthisgdmonth=gddayDate.getMonth();var fthisgdyear=gddayDate.getYear();fthisgdyear=fthisgdyear%100;fthisgdyear=((fthisgdyear<50)?(2000+fthisgdyear):(1900+fthisgdyear));return{'xYear':fthisgdyear,'xMonth':fthisgdmonth,'xDay':fthisgdday};}
function _createDate(gYear,gMonth,gDate,gDay){var startArr=[];var endArr=[];var sttip=false;if(startDateArea.val()!=''&&startDateArea.val()!='yyyy-mm-dd'){sttip=true;startArr=startDateArea.val().split('-');}
monthdays=new Array(31,28,31,30,31,30,31,31,30,31,30,31);if(((gYear%4==0)&&!(gYear%100==0))||(gYear%400==0)){monthdays[1]++;}
var outStr='';var tAddStr='<td class="tdCobj tdCobjN"';var tempDate;var ftempDate;if(nowTarget[0]==startDateArea[0]){if(gYear==thisyear&&gMonth==thismonth){tempDate=thisdate;}
else{tempDate=1;}}
else{}
var startspaces=gDate;while(startspaces>7){startspaces-=7;}
startspaces=gDay-startspaces+1;if(startspaces<0){startspaces+=7;}
outStr+='<table cellpadding="0" cellspacing="0" border="0" class="dateSel_t">';outStr+='<tr>';outStr+='<th align="center" style="color:#ff9900"><strong>日</strong></th>';outStr+='<th align="center">一</th>';outStr+='<th align="center">二</th>';outStr+='<th align="center">三</th>';outStr+='<th align="center">四</th>';outStr+='<th align="center">五</th>';outStr+='<th align="center" style="color:#ff9900"><strong>六</strong></th>';outStr+='</tr>';outStr+='<tr>';for(s=0;s<startspaces;s++){outStr+='<td></td>';}
var count=1;while(count<=monthdays[gMonth]){for(b=startspaces;b<7;b++){if(count<=monthdays[gMonth]){var tetip=false;var teDate=new Date();var teArr=GetDateStr(teDate,settings.leaveDate-1).split('-');teDate=new Date(teArr[0],teArr[1]-1,teArr[2]);var tpDate=new Date(gYear,gMonth,count);if(tpDate>teDate)tetip=true;if(count<tempDate||tetip){outStr+='<td>';}
else{if(sttip){if(nowTarget[0]==startDateArea[0]){if(startArr[0]==gYear.toString()&&startArr[1]==adjustNumber(gMonth+1)&&startArr[2]==adjustNumber(count))
outStr+=tAddStr;else
outStr+='<td class="tdCobj"';}
else{if(startArr[0]==gYear.toString()&&startArr[1]==adjustNumber(gMonth+1)&&startArr[2]==adjustNumber(count))
outStr+=tAddStr;else if(endArr[0]==gYear.toString()&&endArr[1]==adjustNumber(gMonth+1)&&endArr[2]==adjustNumber(count))
outStr+='<td class="tdCobj tdCobjN"';else
outStr+='<td class="tdCobj"';}}
else if(sttip){if(sttip){if(startArr[0]==gYear.toString()&&startArr[1]==adjustNumber(gMonth+1)&&startArr[2]==adjustNumber(count))
outStr+=tAddStr;else
outStr+='<td class="tdCobj"';}
else{}}
else{outStr+='<td class="tdCobj"';}
outStr+=(' data-id="'+gYear.toString()+'-'+adjustNumber(gMonth+1)+'-'+adjustNumber(count)+'">');}
outStr+=adjustFestival(count,gMonth+1,gYear,(b==0||b==6));}
outStr+='</td>';count++;}
outStr+='</tr>';startspaces=0;}
outStr+='</table>';return outStr;}
function adjustNumber(number,len){number+='';len=len||2;var length=number.length;if(length<len){for(var i=len-length;i>0;i--){number='0'+number;}}
return number;}
function adjustFestival(day,month,year,flag){var str=flag?('<strong>'+day.toString()+'</strong>'):day.toString();var date=adjustNumber(month)+adjustNumber(day);var lunarFestivals=festivalMap['lunarFestivals'];$.each(festivalMap,function(key,value){if("solar"==key&&value[date]){str='<strong>'+value[date]+'</strong>';return false;}else if("lunar"==key&&value[year]){var index=value[year].indexOf(date);if(index>-1){str='<strong>'+lunarFestivals[index]+'</strong>';return false;}}});return str;}
function getWeekday(sDate){var dt=new Date(sDate.replace(/-/g,'/'));var todayDate=new Date();var strArr1=GetDateStr(todayDate,0).split('-');var strArr2=GetDateStr(dt,0).split('-');var str11=new Date(strArr1[0],strArr1[1]-1,strArr1[2]);var str22=new Date(strArr2[0],strArr2[1]-1,strArr2[2]);var a=['星期日','星期一','星期二','星期三','星期四','星期五','星期六'];var result=(str22-str11)/3600000;switch(result){case 0:return"今天";break;case 24:return"明天";break;case 48:return"后天";break;default:return a[dt.getDay()];}}
_initialize();}})(jQuery);;;(function(){var dropEles=[];function hideAllDrops(){for(var i=0;i<dropEles.length;i++){dropEles[i].hide();}}
function checkInputValid(obj){var val=parseInt(obj.value);if(isNaN(val)){val='';}
obj.value=val;}
$.fn.dropselect=function(){return this.each(function(){var $this=$(this),selectBox=$this.siblings(".select");dropEles.push(selectBox);$this.focus(function(){hideAllDrops();selectBox.show();}).bind('keydown keyup keypress contextmenu',function(e){e.preventDefault();}).bind('input propertychange change',function(){checkInputValid($this[0]);});selectBox.find("a").click(function(){$this.val($(this).text());checkInputValid($this[0]);selectBox.hide();});$this.parent().click(function(e){e.stopPropagation();});$(document).click(function(){selectBox.hide();});});}})();;;(function(){var cities={};var currentInputs={};var defaultOption={id:'J_Cities',cityUrl:'/yii.php?r=dynamic/ajaxGetCity',onChange:function(){},onError:function(){}}
$.fn.citysearch=function(){var option;if(arguments.length===1){option=arguments[0];}else{option={id:arguments[0],onChange:arguments[1],onError:arguments[2],cityUrl:arguments[3]}}
return this.each(function(){var textBox=$(this);var cityiesEle,tabEles,boxEles;var config=$.extend({},defaultOption,option);cityiesEle=$('#'+config.id).clone();cityiesEle.removeAttr('id').hide().appendTo('body');tabEles=$(".pkg_city_cat li",cityiesEle);boxEles=$(".pkg_city_list_cat",cityiesEle);function isParent(child,parent){var parents=child.parents();var res=false;if(child[0]===parent){res=true;}else{parents.each(function(){if(this===parent){res=true;return false;}});}
return res;}
function bindCitySearch(textBox,layer){var lowerIE=$.browser.msie&&$.browser.version<='8.0';var blurByLayer=false;if(lowerIE){textBox.focus(function(){this.select();showBox();}).blur(function(e){if(blurByLayer){e.preventDefault();e.stopPropagation();blurByLayer=false;}else{hideBox();}});layer.bind('mousedown',function(){blurByLayer=true;});$(document).mousedown(function(e){if(isParent($(e.target),layer[0])||e.target===textBox[0]){textBox.focus();}else{hideBox();}});}else{textBox.focus(function(){this.focused=true;this.select();showBox();}).mouseup(function(){if(this.focused){this.focused=false;return false;}}).blur(function(){hideBox();});layer.bind('mousedown',function(e){e.preventDefault();e.stopPropagation();});}
textBox.bind('change input propertychange',function(e){if(e.type!=='change'&&e.type!=='input'&&!(e.type==='propertychange'&&e.originalEvent.propertyName==='value')){return;}
if(textBox.val()!==''){hideBox();}else{showBox();}});}
function showBox(){var offset=textBox.offset();offset.height=textBox.outerHeight();_.each(cities,function(city){city.hide();});if(offset){cityiesEle.css({"left":offset.left,"top":offset.top+offset.height}).show();}}
function hideBox(){cityiesEle.hide();cityiesEle.siblings(".pkg_error_tip").hide();}
function setCity(cityCode,cityName){textBox.attr('code',cityCode);textBox.val(cityName);config.onChange({code:cityCode,name:cityName},0);}
$(window).resize(function(){if(cityiesEle.is(':visible')){setTimeout(showBox,30);}});cityiesEle.delegate(".pkg_city_list a",'click',function(){var code=$(this).attr('code');var cityName=$(this).text();setCity(code,cityName);hideBox();});cityiesEle.delegate(".pkg_city_history_list a",'click',function(){var code=$(this).attr('code');var cityName=$(this).text();setCity(code,cityName);hideBox();});tabEles.click(function(){var tab=$(this);var index=tab.index();tabEles.removeClass("current");tab.addClass("current");boxEles.addClass('hide').hide();$(boxEles.get(index)).show().removeClass('hide');});bindCitySearch(textBox,cityiesEle);textBox.bind('keydown',function(e){if(e.keyCode!=9&&e.keyCode!=13){textBox.removeAttr('code');hideBox();}}).pkgautocomplete({serviceUrl:config.cityUrl,dataType:'json',autoSelectFirst:false,showNoSuggestionNotice:true,noSuggestionNotice:'找不到相关的城市',width:textBox.outerWidth(),transformResult:function(response){if(response.code==200){response=response.data;_.each(response.suggestions,function(item){item.value=item.name;});}else{response=$.extend({"query":"","suggestions":[]},response.data);}
return response;},formatResult:function(suggestion){return suggestion.value+'('+suggestion.pinyin+')';},onFocus:function(){},onSearchStart:function(){if(this.value&&this.getAttribute('code')){return false;}else{}},beforeRender:function(){hideBox();},onSelect:function(suggestion){textBox.attr('code',suggestion.cityCode);config.onChange(suggestion,1);},onHint:function(hint){},onInvalidateSelection:function(){}});});};})();;$(function(){var html='<div class="layer" id="J_Dialog"><div class="mask"></div><div class="dialog"><div class="dialog_inner"><div class="dialog_head"><div class="dialog_tit">提示</div><a class="dialog_close" href="javascript:;"><i class="icon"></i></a></div><div class="dialog_con"></div><div class="dialog_btns"><a href="javascript:;" class="dialog_btn dialog_btn_ok">确定</a><a href="javascript:;" class="dialog_btn dialog_btn_cancle">取消</a></div></div></div></div>';var layerEle=$(html);var outerCon=$('.dialog',layerEle);var TitEle=$(".dialog_tit",layerEle);var conEle=$(".dialog_con",layerEle);var btnsEle=$(".dialog_btns",layerEle);var closeBtnEle=$(".dialog_close",layerEle);var okBtnEle=$(".dialog_btn_ok",layerEle);var cancleBtnEle=$(".dialog_btn_cancle",layerEle);var okCallback,cancleCallback,closeCallback;function closeDialog(){layerEle.hide();layerEle[0].className='layer';outerCon.css({'width':'auto','height':'auto','margin':0});if(closeCallback){closeCallback();}}
function showDialog(){layerEle.css({width:Math.max(document.documentElement.scrollWidth,document.body.scrollWidth),height:Math.max(document.documentElement.scrollHeight,document.body.scrollHeight)}).show();outerCon.css({'marginLeft':-outerCon.width()/2,'marginTop':-outerCon.height()/2});}
function openDialog(option){conEle.html(option.msg||"");option.title&&TitEle.text(option.title);option.className&&layerEle.addClass(option.className);option.width&&outerCon.width(option.width);option.height&&outerCon.height(option.height);okBtnEle.text(option.okLabel||'确定');cancleBtnEle.text(option.cancleLabel||'取消');if(option.btnHidden){btnsEle.hide();}else{btnsEle.show();okCallback=option.ok||null;cancleCallback=option.cancle||null;closeCallback=option.close||null;}
showDialog();}
closeBtnEle.click(closeDialog);okBtnEle.click(function(){var isClose=true;if(okCallback){isClose=okCallback();}
isClose!==false&&closeDialog();});cancleBtnEle.click(function(){var isClose=true;if(cancleCallback){isClose=cancleCallback();}
isClose!==false&&closeDialog();});layerEle.appendTo('body');window.openDialog=openDialog;window.hideDialog=closeDialog;});;;(function(win,_,$){var properties={listUrl:'',hotelInfoUrl:'',priceCalendarUrl:'',pkgCalendarUrl:'',flightCalendarUrl:''};function DataServer(){Event.call(this);}
DataServer.prototype={set:function(property,value){properties[property]=value||properties[property];},get:function(property){return properties[property];},initLoad:function(data,callback){$.get(this.get('listUrl'),data,function(data){callback&&callback(data);},'json');},getThrough:function(data,callback){$.get('/yii.php?r=train/trainTicket/getTrainInfo',data,function(data){callback(data);},'json');},getTkAddLoad:function(data,callback){$.get('/yii.php?r=train/trainTicket/uponArriveList',data,function(data){callback(data);},'json');},loadList:function(data,callback){$.get(this.get('listUrl'),data,function(data){callback&&callback(data);},'json');},getPkgCalendar:function(data,callback){callback&&callback({current:data.flightStartDay,data:$.extend([],window.dateEvents),startDate:'2014-10-01',today:'2014-10-01',endDate:'2014-10-31'});}}
win.getDataServer=_.once(function(){return new DataServer();});})(window,_,jQuery);;;(function(win,_){var html='<div class="pkg_error" id="J_Errors"><div class="pkg_error_con"><h3></h3></div></div>';function ErrorInfo(wrap){Event.call(this);this.wrap=wrap;this.wrap.find("#J_Errors").remove();this.init();}
ErrorInfo.prototype=new Event;_.extend(ErrorInfo.prototype,{init:function(){var container=$(html);this.container=container;this.errorCon=$('h3',container);this.wrap.css({position:'relative'});container.appendTo(this.wrap);},hide:function(){this.container.hide();},show:function(msg){this.errorCon.html(msg||html);this.container.css({position:'static'}).removeClass('loading').show();},showLoading:function(isCover,ele){if(!ele){return false;}
var offset=ele.offset();var height=ele.outerHeight();var width=this.wrap.outerWidth();var container=this.container;var wrapOffset;var iTop;if(ele.is(':hidden')){container.css({position:'relative',width:'100%',height:150,top:0});}else{wrapOffset=this.wrap.offset();if(isCover){container.css({position:'relative',width:'100%',height:150,top:0});}else{iTop=offset.top-wrapOffset.top+height;container.css({position:'absolute',top:iTop,width:width,height:this.wrap.height()-iTop});}}
this.errorCon.text('小牛牛正在努力加载中...');container.addClass('loading');this.container.show();},setMsg:function(msg){if(msg){html=msg;}}});win.CreateErrorInfo=_.once(function(wrap){return new ErrorInfo(wrap);});})(window,_);;function InfoTicket(obj,info,data){Event.call(this);_.extend(this);var inputs=$(':text',obj);this.container=obj;this.inputs=inputs;this.from=inputs[0];this.to=inputs[1];this.start=inputs[2];this.container=obj;this.errorEle=$('<div />').addClass('pkg_error_tip');this.init(data);}
InfoTicket.prototype=new Event;_.extend(InfoTicket.prototype,{init:function(data){var self=this;var today=window.TKToday
if(today){today=new Date(today.replace(/\-/g,'/'));}else{today=new Date();}
today.setHours(0);today.setMinutes(0);today.setSeconds(0);today.setMilliseconds(0);function GetDateStr(pdate,AddDayCount){var dd=pdate;dd.setDate(dd.getDate()+AddDayCount);var y=dd.getYear();y=y%100;y=((y<50)?(2000+y):(1900+y));var m=dd.getMonth()+1;var d=dd.getDate();return y+"-"+adjustNumber(m)+"-"+adjustNumber(d);}
function adjustNumber(number,len){number+='';len=len||2;var length=number.length;if(length<len){for(var i=len-length;i>0;i--){number='0'+number;}}
return number;}
function getWeekday(sDate){var dt=new Date(sDate.replace(/-/g,'/'));var todayDate=new Date();var strArr1=GetDateStr(todayDate,0).split('-');var strArr2=GetDateStr(dt,0).split('-');var str11=new Date(strArr1[0],strArr1[1]-1,strArr1[2]);var str22=new Date(strArr2[0],strArr2[1]-1,strArr2[2]);var a=['星期日','星期一','星期二','星期三','星期四','星期五','星期六'];var result=(str22-str11)/3600000;switch(result){case 0:return"今天";break;case 24:return"明天";break;case 48:return"后天";break;default:return a[dt.getDay()];break;}}
function getDateAlase(date){return getWeekday(date);}
function isEqual(src,rel){if(src.getFullYear()===rel.getFullYear()&&src.getMonth()===rel.getMonth()&&src.getDate()===rel.getDate()){return true;}else{return false;}}
function checkDate(){var placeholder=$(self.start).siblings(".pkg_info_placholder");var date=$(self.start).val();if(date){placeholder.text(getDateAlase(date)+'出发');}}
this.inputs.filter(".hide_placeholder").placeholder().end().filter(".input_addr").each(function(index){var inputEle=this;var _this=$(this);var parentEle=_this.parent();var holderEle=_this.siblings('.pkg_info_placholder');var txtTip=holderEle.text();if(!_this.val()||!_this.attr('code')){_this.val('');}
_this.citysearch({id:'J_Cities_'+(index+1),cityUrl:'http://www.tuniu.com/yii.php?r=train/trainTicket/getStation',onChange:function(cityData,flag){var nextAddr=self.inputs[index+1];parentEle.removeClass('error');holderEle.text(txtTip).hide();_this.trigger('change');self.trigger('change',self._get(),index===0?'from':'to');if(index===0){nextAddr.focus();}else if(index==1){nextAddr.click();nextAddr.focus();}
inputEle._originFlag=flag||0;inputEle._originData=cityData;},onError:function(){parentEle.addClass('error');holderEle.text('地址不存在').show();}});}).end().filter('.input_date').change(function(){var _this=$(this);var placeholder=_this.siblings(".pkg_info_placholder");var date=_this.val();if(_this.val()){placeholder.text(getDateAlase(date)+' 出发').show();}
self.trigger('change',this.value);}).TN_pkdate({leaveDate:60,wrap:$("body"),onSelect:function(selectWeek,nowTarget){var self=this.currentObj;var placeholder=self.siblings(".pkg_info_placholder");var date=self.val();if(self.val()){placeholder.text(getDateAlase(date)+'出发');}
self.trigger('change',self.val());}});$('.icon_change',self.container).click(function(){var fromAddr=self.from.value||'';var fromCode=self.from.getAttribute('code')||'';var toAddr=self.to.value||'';var toCode=self.to.getAttribute('code')||'';if(!toCode&&!fromCode){return;}
self.from.value=self.to.value;self.from.setAttribute('code',self.to.getAttribute('code')||'');self.to.value=fromAddr;self.to.setAttribute('code',fromCode);$(self.from).trigger('change');$(self.to).trigger('change');self.trigger('change',self._get(),'from');self.trigger('change',self._get(),'to');});if(data!==void(0)){if(data.from){self.from.setAttribute('code',data.from);self.from.value=data.fromName;}
if(data.to){self.to.setAttribute('code',data.to);self.to.value=data.toName;}
var startTimeVal=data.date,startTimeVal=startTimeVal.replace(/-+/g,'/'),urlDate=(+new Date(startTimeVal)),result=new Date(startTimeVal),flag=/\d+/g.test(result);var date=new Date(),year=date.getFullYear(),month=date.getMonth()+1,day=date.getDate(),nowDate=+new Date();if(flag&&urlDate>=nowDate){self.start.value=data.date;}
else{sNowTime=''+year+'-'+month+'-'+day;self.start.value=sNowTime;}
checkDate();self.inputs.trigger('change').trigger('blur');}},_get:function(){var from=this.from.getAttribute('code');var fromName=this.from.value;var to=this.to.getAttribute('code');var toName=this.to.value;var start=this.start.value;return{from:from,fromName:fromName,to:to,toName:toName,start:start,fromFlag:this.from._originFlag,fromOriginData:this.from._originData,toFlag:this.to._originFlag,toOriginData:this.to._originData}},get:function(){var from=this.from.getAttribute('code');var to=this.to.getAttribute('code');var start=this.start.value;var addrValidRes,dateValidRes;var errors=[];addrValidRes=Tools.checkAddr('','',this.from,this.to);if(this.disabled){dateValidRes=Tools.checkDate(start,null,this.start,null);}else{dateValidRes=Tools.checkDate(start,null,this.start,null);}
if(addrValidRes.error===0&&dateValidRes.error===0){return{from:from,fromName:this.from.value,to:to,toName:this.to.value,start:start,fromFlag:this.from._originFlag,fromOriginData:this.from._originData,toFlag:this.to._originFlag,toOriginData:this.to._originData}}else{if(addrValidRes.error===2){this.showError('出发地与目的地相同',this.from);}else if(addrValidRes.error===1){this.showError(addrValidRes.msg,addrValidRes.target);}
if(addrValidRes.error){errors.push(addrValidRes);}
if(dateValidRes.error===1){this.showError(dateValidRes.msg,dateValidRes.target);errors.push(dateValidRes);}
return{error:true,list:errors};}},check:function(){var from=this.from.getAttribute('code');var to=this.to.getAttribute('code');var start=this.start.value;var addrValidRes,dateValidRes;addrValidRes=Tools.checkAddr('','',this.from,this.to,true);if(this.disabled){dateValidRes=Tools.checkDate(start,null,this.start,null,true);}else{dateValidRes=Tools.checkDate(start,null,this.start,null,true);}
if(addrValidRes.error===0&&dateValidRes.error===0){return true;}else{return false;}},enable:function(){this.disabled=false;$(this.back).removeClass('disabled').parent().removeClass('disabled');},disable:function(){this.disabled=true;$(this.back).addClass('disabled').parent().addClass('disabled');},set:function(property,value){if(property==='start'){this.start.value=value;$(this.start).trigger('change');}else if(property==='back'){this.back.value=value;}},showError:function(msg,target){return;var errorEle=$(target).siblings('.pkg_error_tip');if(errorEle.length){errorEle.text(msg);}else{this.errorEle.clone().text(msg).insertAfter(target);}
this.container.addClass('error');},hideError:function(target){if(target){$(target).siblings('.pkg_error_tip').remove();}else{this.container.find('.pkg_error_tip').remove();}
if(this.container.find('.pkg_error_tip').length===0){this.container.removeClass('error');}}});;var Tools={infoItems:{'WF':window.WangfanInfo,'AD':window.InfoAddress,'DE':window.InfoDest,'HT':window.InfoHotel,'SF':window.InfoStaff,'TK':window.InfoTicket},checkAddr:function(from,to,fromObj,toObj,slient){var blankFlag=false;var placeholder='地址';var target;var fromName=from,toName=to;if(!from&&fromObj){from=fromObj.getAttribute('code');fromName=fromObj.value;}
if(!to&&toObj){to=toObj.getAttribute('code');toName=toObj.value;}
if(fromObj&&(!from||!fromName)){blankFlag=true;placeholder=$(fromObj).siblings('.pkg_info_placholder').text();target=fromObj;}else if(toObj&&(!to||!toName)){blankFlag=true;placeholder=$(toObj).siblings('.pkg_info_placholder').text();target=toObj;}
if(blankFlag){return{error:1,msg:'请选择'+placeholder,target:target}}
if(fromObj&&toObj&&(from===to)&&(fromName==toName)){return{target:toObj,error:2,msg:'出发地与目的地不能相同'}}
return{error:0};},checkDate:function(start,back,startObj,backObj,slient){var blankFlag=false;var placeholder='';var target;if(startObj&&(!start||start==='yyyy-mm-dd')){blankFlag=true;placeholder=$(startObj).siblings('.pkg_info_placholder').text();target=startObj;}else if(backObj&&(!back||back==='yyyy-mm-dd')){blankFlag=true;placeholder=$(backObj).siblings('.pkg_info_placholder').text();target=backObj;}
if(blankFlag){return{error:1,msg:'请选择'+placeholder+'日期',target:target}}
return{error:0};},checkBlank:function(){var flag=true;_.each(arguments,function(ele){var val=$.trim(ele.value);if(!(!val||val=='yyyy-mm-dd')){flag=false;}});return flag;},getNextDate:function(current,delta){var currentDate;if(typeof current==='string'){current=current.replace(/\-/g,'/');}else{current=current.getFullYear()+'/'+(current.getMonth()+1)+'/'+current.getDate();}
currentDate=new Date(current);delta=delta||1;currentDate.setDate(currentDate.getDate()+delta);return currentDate.getFullYear()+'-'+Tools.adjustNumber(currentDate.getMonth()+1)+'-'+Tools.adjustNumber(currentDate.getDate());},getSearchQuery:function(){var search=location.search;var res={};if(search){search=search.replace(/^\?/,'');search=search.split('&');_.each(search,function(item){item=item.split('=');res[item[0]]=item[1];});}
return res;},adjustNumber:function(number,len){number+='';len=len||2;var length=number.length;if(length<len){for(var i=len-length;i>0;i--){number='0'+number;}}
return number;},isBlankDate:function(dateString){dateString=dateString.replace(/(^\s*|\s*$)/g,'');if(dateString==='yyyy-mm-dd'||dateString===''){return true;}
return false;},getDateMDString:function(date){if(typeof date==='string'){date=new Date(Tools.changeDateFormat(date));}
var month=Tools.adjustNumber(date.getMonth()+1);var date=Tools.adjustNumber(date.getDate());return month+'-'+date;},adjustNumber:function(number,len){number+='';len=len||2;var length=number.length;if(length<len){for(var i=len-length;i>0;i--){number='0'+number;}}
return number;},changeDateFormat:function(date){return date.replace(/\-/g,'/');},calcDeltaDate:function(start,end){start=new Date(Tools.changeDateFormat(start));end=new Date(Tools.changeDateFormat(end));return Math.abs((start-end)/86400000);},getDeltaDay:function(from,to){if(!from||!to){return 0;}
from=new Date(Tools.changeDateFormat(from));to=new Date(Tools.changeDateFormat(to));return Math.abs((to-from)/86400000);}}
_.mixin({formatDate:function(date){date=/\d{1,2}\-\d{1,2}$/.exec(date);if(date){date=_.map(date[0].split('-'),function(num){if(num.length===1){return'0'+num;}else{return num;}});return date.join('-');}else{return date;}}});$.fn.placeholder=function(){return this.each(function(){var placeholder=$(this).siblings(".pkg_info_placholder");$(this).bind("input propertychange change",function(){if(this.value){placeholder.hide();}else{placeholder.show();}});if(this.value){placeholder.hide();}});};;(function(win,_){function processData(data){var tmp={};var hotels=[];tmp.WF=data.isSingleTrip==1?0:1;tmp.AD={from:data.departureCityCode,fromName:data.departureCityName,to:data.destinationCityCodes,toName:data.destinationCityName,start:data.departsDate,back:data.destinationData};tmp.SF={adult:parseInt(data.adultNum)||0,child:parseInt(data.childNum)||0};_.each(data.hotel,function(hotel){hotels.push({addr:hotel.cityCode,addrName:hotel.cityName,start:hotel.departsDateBegin,end:hotel.departsDateEnd});});tmp.HT=hotels;tmp.TK=data.ticket;tmp.TK.start=tmp.TK.date;tmp.TK.from=tmp.TK.fromCityCode;tmp.TK.to=tmp.TK.toCityCode;return tmp;}
function Info(data){Event.call(this);this.service=getDataServer();this.container=$('#J_PkgInfo');this.items={};this.infoData={};this.init(data);}
Info.prototype=new Event;_.extend(Info.prototype,{init:function(data){var self=this;var items=self.items;var infoItems=self.container.find('.J_PkgInfoItem');var tempData=data;if(data){data=processData(data);}
self.infoData=data;if(infoItems.length){self.changeState=false;infoItems.each(function(){var type=$(this).attr('data-type');if(Tools.infoItems[type]){items[type]=new Tools.infoItems[type]($(this),self,data&&data[type]);}});var htItem=items['HT'];var adItem=items['AD'];var wfItem=items['WF'];if(htItem){htItem.bind('add remove',function(){self.trigger('hotelModify',this);});}
if(wfItem&&adItem){wfItem.bind('change',function(data){if(data==1){adItem.enable();}else{adItem.disable();}});adItem.bind('change',function(data,type){if(type==='back'&&data.back){wfItem.set(1);adItem.enable();}});}
if(htItem&&adItem){adItem.bind('change',function(data,type){if(data.to&&type==='to'){htItem.set(0,'addr',data.to,data.toName);}
if(data.start!='yyyy-mm-dd'&&type==='start'){htItem.set(0,'start',data.start);}
if(data.back!='yyyy-mm-dd'&&type==='back'&&htItem.items.length===1){htItem.set(0,'end',data.back);}});}
if(items['WF']&&data&&data['WF']!==void(0)){items['WF'].set(data['WF']);}}else{self.changeState=true;}
if(tempData&&tempData.flightData){$('<input type="hidden" name="flightData" />').val(tempData.flightData).appendTo(self.container);}
if(tempData&&tempData.hotelData){$('<input type="hidden" name="hotelData" />').val(tempData.hotelData).appendTo(self.container);}
$("#more-flight span").click(function(){window.location.href="http://www.tuniu.com/flight/";});$("#J_FoldExpandBtn").click(function(){var pkgInfo=$(this).parent();if(pkgInfo.hasClass("pkg_info_expand")){pkgInfo.removeClass("pkg_info_expand");$("#J_PkgInfo").slideUp(700);}else{pkgInfo.addClass("pkg_info_expand");$("#J_PkgInfo").slideDown(700);}});$('#J_SearchBtn').click(function(){self.search(false);});if($('#recommendFlightTemp').length>0){self.recommendFlightTemplate=_.template($('#recommendFlightTemp').html());self.getRecommendFlightInfo({from:window.PostData.ticket.from,to:window.PostData.ticket.to,start:window.PostData.ticket.start,fromName:window.PostData.ticket.fromName,toName:window.PostData.ticket.toName});}},search:function(flag){var self=this;var res=self._get();if(!$.isArray(res)){if($('#recommendFlightTemp').length>0){self.getRecommendFlightInfo(res.TK);}
self.trainSearchHistoryUpdate(self.get());$(this).children('a').text('重新搜索');self.trigger('search',$.extend(self.get(),{'indexFlag':flag}));}},check:function(){var flag=true;$.each(this.items,function(){var r=this.check();if(!r){flag=false;return false}});return flag;},_get:function(){var self=this;var res={};var flag=true;var errors=[];if(self.changeState){return self.infoData;}
$.each(self.items,function(k){var r=this.get();if(r.error!==true){res[k]=r;}else{errors=errors.concat(r.list);flag=false;}});if(!flag){self.trigger('invalid',errors);}
self.infoData=res;return flag?res:errors;},get:function(){return $.extend(true,{},this.infoData);},load:function(sendData){var self=this;self.trigger('beforeLoad',self.get());self.service.initLoad(sendData,function(data){if(data&&data.code==200){self.trigger('load',data);}else{self.trigger('error',data);}});},loadData:function(data){if(data){this.infoData=data;this.trigger('search',this.get());}},set:function(type,property,value){var item=this.items[type];if(item){item.set(property,value);this.infoData[type][property]=value;}},getRecommendFlightInfo:function(params){var self=this;var now=new Date();var year=now.getFullYear();var month=now.getMonth()+1;var day=now.getDate();var nowDate=year+'-'+month+'-'+day;var minTime=new Date(year,month-1,day,22,00,00).getTime();var maxTime=new Date(year,month-1,day+1,00,00,00).getTime();if((nowDate==params.start)&&(now.getTime()>=minTime)&&(now.getTime()<=maxTime)){$('.recommend-flight').hide();}else{var recommendFlightParams={"orgCityCode":params.from,"departureDate":params.start,"dstCityCode":params.to,"type":1};var url='http://flight.api.tuniu.com/query/queryCalendarPrices';var recommendFlightInfo={};var link="";$.ajax({url:url,data:{d:JSON.stringify(recommendFlightParams)},dataType:'json',success:function(json){if((true==json.success)&&(null!=json.data)){var data=json.data;for(var i=0;i<data.length;i++){if(data[i].date==params.start){var departureDate=params.start;var startDateArr=departureDate.split('-');var startDate=startDateArr[1]+'-'+startDateArr[2];recommendFlightInfo={"orgCityCode":params.from,"orgCityName":params.fromName,"dstCityCode":params.to,"dstCityName":params.toName,"departureDate":params.start,"startDate":startDate,"price":data[i].price};link="http://www.tuniu.com/flight";link+="/city_"+params.from+"_"+params.to+"?start="+params.start+"&type=1";break;}}
if($.isEmptyObject(recommendFlightInfo)){$('.recommend-flight').hide();$('#more-flight').hide();}else{var html=self.recommendFlightTemplate({data:recommendFlightInfo});$('.recommend-flight').html(html);$('.recommend-flight .btn').unbind('click').click(function(){window.location.href=link;});$('.recommend-flight').show();$('#more-flight').show();}}else{$('.recommend-flight').hide();$('#more-flight').hide();}},error:function(){$('.recommend-flight').hide();$('#more-flight').hide();}})}},trainSearchHistoryUpdate:function(params){params=params.TK;var base64=new Base64();var trainSearchHistory=$.parseJSON(base64.decode(getCookie("train_search_history")||''));if(!trainSearchHistory){trainSearchHistory={};}
if(!trainSearchHistory.departCity){trainSearchHistory.departCity={};}
if(!trainSearchHistory.destinationCity){trainSearchHistory.destinationCity={};}
if(trainSearchHistory.departCity['t'+params.from]){delete trainSearchHistory.departCity['t'+params.from];}
if(trainSearchHistory.destinationCity['t'+params.to]){delete trainSearchHistory.destinationCity['t'+params.to];}
trainSearchHistory.departCity['t'+params.from]={'code':params.from,'name':params.fromName}
trainSearchHistory.destinationCity['t'+params.to]={'code':params.to,'name':params.toName}
var pkgCityHistory=$('<ul class="pkg_city_history_list_cat clearfix"><div class="clearfix"><span></span></div></ul>');if(trainSearchHistory.destinationCity){var tempDestinationCity=[];$.each(trainSearchHistory.destinationCity,function(i,item){tempDestinationCity.push(item);});tempDestinationCity.reverse();var destinationCityHistory=pkgCityHistory.clone();var destinationCity="";$.each(tempDestinationCity,function(i,item){if(i<7){destinationCity+='<li title="'+item.name+'"><a code="'+item.code+'" href="javascript:;">'+item.name+'</a></li>';}});$("div",destinationCityHistory).append(destinationCity);$(".pkg_city_history_list").eq(1).html(destinationCityHistory.clone(true));$(".pkg_city_history_list").eq(3).html(destinationCityHistory.clone(true));}
if(trainSearchHistory.departCity){var tempDepartCity=[];$.each(trainSearchHistory.departCity,function(i,item){tempDepartCity.push(item);});tempDepartCity.reverse();var departCityHistory=pkgCityHistory.clone();var departCity="";$.each(tempDepartCity,function(i,item){if(i<7){departCity+='<li title="'+item.name+'"><a code="'+item.code+'" href="javascript:;">'+item.name+'</a></li>';}});$("div",departCityHistory).append(departCity);$(".pkg_city_history_list").eq(0).html(departCityHistory.clone(true));$(".pkg_city_history_list").eq(2).html(departCityHistory.clone(true));}}});win.CreateInfo=_.once(function(data){return new Info(data);});})(window,_);;;(function(){function PkgTip(){this.ele=$('<div />').addClass('pkg_error_tip');this.container=$('<span />');this.visible=false;this._target=null;this._rel=null;this._msg='';$('<i />').addClass('pkg_error_tip_icon').appendTo(this.ele);this.container.appendTo(this.ele);this.ele.hide().appendTo('body');}
PkgTip.prototype.show=function(target,msg,rel){this._target=target;this._msg=msg;this._rel=rel;this.update();this.container.text(msg);this.ele.show();this.visible=true;}
PkgTip.prototype.hide=function(){this.ele.hide();this.container.text('');this.visible=false;}
PkgTip.prototype.update=function(){var target=$(this._target);var wrap=this._rel;var wrapOffset=wrap.offset();var targetOffset=target.offset();var targetHeight=target.outerHeight();this.ele.css({'min-width':wrap.width(),'left':wrapOffset.left,'top':targetOffset.top+targetHeight});}
window.CreatePkgError=_.once(function(){var error=new PkgTip();$(window).resize(function(){if(error.visible){error.update();}});return error;});})();;var tnSlideTemp=true;function addC(){$(".horizontal").each(function(){$(this).find("li").eq(0).addClass("on");$(this).find(".aline").addClass("hide");$(this).find(".aline").eq(0).removeClass("hide");})}
function changeTag(){$(".horizontal").each(function(){$(this).find("li").each(function(){$(this).click(function(){$(this).addClass("on").siblings().removeClass("on");var i=$(this).index();$(this).parents(".horizontal").find(".aline").eq(i).removeClass("hide").siblings(".aline").addClass("hide");})})})}
function changeOnlyGD(){$(".check input[name='onlyGD']").attr("checked",false);$("#J_OnlyGDBtn_On").click(function(){$(this).parent('.train_form_radio').addClass('open');$(this).siblings('.train_form_radio_item').removeClass('checked');$(this).addClass('checked');$(".check input[name='onlyGD']").attr("checked",true);});$("#J_OnlyGDBtn_Off").click(function(){$(this).parent('.train_form_radio').removeClass('open');$(this).siblings('.train_form_radio_item').removeClass('checked');$(this).addClass('checked');$(".check input[name='onlyGD']").attr("checked",false);});}
function trainSearchHistoryShow(trainSearchHistory){var pkgCityHistory=$('<div class="pkg_city_history_tit">搜索历史</div><div id="J_PKGCityHistoryList" class="pkg_city_history_list"><ul class="pkg_city_history_list_cat clearfix"><div class="clearfix"></div></ul></div>')
if(trainSearchHistory.departCity){var departCityHistory=pkgCityHistory.clone();var departCity='<span></span>';$.each(trainSearchHistory.departCity,function(i,item){departCity+='<li title="'+item.name+'"><a code="'+item.code+'" href="javascript:;">'+item.name+'</a></li>';});$(".pkg_city_history_list_cat div",departCityHistory).html(departCity);$("#J_Cities_1 .pkg_city_tit").after(departCityHistory);}
if(trainSearchHistory.destinationCity){var destinationCityHistory=pkgCityHistory.clone();var destinationCity='<span></span>';$.each(trainSearchHistory.destinationCity,function(i,item){destinationCity+='<li title="'+item.name+'"><a code="'+item.code+'" href="javascript:;">'+item.name+'</a></li>';});$(".pkg_city_history_list_cat div",destinationCityHistory).html(destinationCity);$("#J_Cities_2 .pkg_city_tit").after(destinationCityHistory);}}
var huochepiao=huochepiao||{};huochepiao={init:function(){huochepiao.bannerSlide();},bannerSlide:function(){var bannerPic=$("#bannerPic");var bannerPic_li=bannerPic.find("li");var bannerPic_li_lg=bannerPic.find("li").length;var banner_temp=0;var banner_Timeout="";var nc_str='<p class="train_curs"><span class="nc_cur"></span>';if(bannerPic_li_lg>1){for(var j=1;j<bannerPic_li_lg;j++){nc_str+="<span></span>";}
nc_str+='</p>'
bannerPic.append(nc_str);var bannerPic_zzz_curs=bannerPic.find(".train_curs");bannerPic_zzz_curs.find("span").click(function(){var __span_n=$(this).index();bannerPic_li.fadeOut(1000);bannerPic_li.eq(__span_n).fadeIn(1000);bannerPic_zzz_curs.find("span").removeClass("nc_cur").eq(__span_n).addClass("nc_cur");});bannerPic.hover(function(){clearTimeout(banner_Timeout);},function(){banner_Timeout=setInterval(function(){banner_temp++;if(banner_temp<bannerPic_li_lg){bannerPic_li.fadeOut(1000);bannerPic_li.eq(banner_temp).fadeIn(1000);bannerPic_zzz_curs.find("span").removeClass("nc_cur").eq(banner_temp).addClass("nc_cur");}else{banner_temp=0;bannerPic_li.fadeOut(1000);bannerPic_li.eq(banner_temp).fadeIn(1000);bannerPic_zzz_curs.find("span").removeClass("nc_cur").eq(banner_temp).addClass("nc_cur");}},8000);});banner_Timeout=setInterval(function(){banner_temp++;if(banner_temp<bannerPic_li_lg){bannerPic_li.fadeOut(1000);bannerPic_li.eq(banner_temp).fadeIn(1000);bannerPic_zzz_curs.find("span").removeClass("nc_cur").eq(banner_temp).addClass("nc_cur");}else{banner_temp=0;bannerPic_li.fadeOut(1000);bannerPic_li.eq(banner_temp).fadeIn(1000);bannerPic_zzz_curs.find("span").removeClass("nc_cur").eq(banner_temp).addClass("nc_cur");}},8000);}}}
function getCookie(c_name)
{if(document.cookie.length>0)
{c_start=document.cookie.indexOf(c_name+"=")
if(c_start!=-1)
{c_start=c_start+c_name.length+1
c_end=document.cookie.indexOf(";",c_start)
if(c_end==-1)c_end=document.cookie.length
return unescape(document.cookie.substring(c_start,c_end))}}
return""}
function delCookie(name)
{var exp=new Date();exp.setTime(exp.getTime()-1);var cval=getCookie(name);if(cval!=null)
document.cookie=name+"="+cval+";expires="+exp.toGMTString()+"; path=/";}
$(function(){addC();changeTag();changeOnlyGD();huochepiao.init();$.get('/yii.php?r=train/trainTicket/searchOptionsDefault',null,function(data){trainSearchHistoryShow(data.ticket.trainSearchHistory);var info=CreateInfo(data);var pkgError=CreatePkgError();info.bind('search',function(){var formEle=$('#J_PkgForm');var formAction=['http://huoche.tuniu.com/station'];var infoData=info.get();var expire=new Date();expire.setDate(expire.getDate()+24*60*60*1000);document.cookie="deparDate="+escape(infoData.TK.start)+"; expires="+expire.toGMTString()+"; path=/";formEle.find(':text').each(function(){var inputEle=$(this);var hiddenInputEle=inputEle.siblings('[type=hidden]');if(hiddenInputEle.length){hiddenInputEle.val(inputEle.attr('code'));}});if(infoData.TK.fromFlag==1&&infoData.TK.fromOriginData.name!=infoData.TK.fromOriginData.cityName){$('<input />').attr({'type':'hidden','name':'secondary[departureStations][]'}).val(infoData.TK.fromOriginData.code).appendTo(formEle);}
if(infoData.TK.toFlag==1&&infoData.TK.toOriginData.name!=infoData.TK.toOriginData.cityName){$('<input />').attr({'type':'hidden','name':'secondary[arrivalStations][]'}).val(infoData.TK.toOriginData.code).appendTo(formEle);}
formAction.push(parseInt(infoData.TK.from,10));formAction.push(parseInt(infoData.TK.to,10));formEle.attr('action',formAction.join('_'));formEle.submit();});info.bind('invalid',function(errors){var target=$(errors[0].target);target.focus();pkgError.show(target,errors[0].msg,target.parent());target.parent().addClass('error');});},'json');})